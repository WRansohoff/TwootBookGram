name: Build and Deploy LLM Runtime Container

on:
  workflow_dispatch

# Required permissions for AWS OIDC link.
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: "us-east-2"

jobs:
  build_deploy:
    runs-on: ubuntu-20.04
    steps:
      - name: Fetch AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1.7.0
        with:
          role-to-assume: ${{secrets.AWS_ROLE}}
          role-session-name: GitHub_to_AWS_OIDC
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          cd runtime_container/ && \
          pip install -r requirements.txt && \
          pip install -r requirements_torch_cpu.txt

      - name: Download Model
        run: |
          cd runtime_container/opt-350m && \
          git lfs install && \
          git clone https://huggingface.co/facebook/opt-350m && \
          mv opt-350m/* .

      - name: Quantize Model
        run: |
          cd runtime_container/ && \
          optimum-cli export openvino --model opt-350m/ \
                                      --cache_dir opt-350m-ov/model_cache/ \
                                      --task text-generation \
                                      --int8 \
                                      opt-350m-ov/ && \
          python3 -c "from optimum.intel import OVModelForCausalLM; OVModelForCausalLM.from_pretrained('opt-350m-ov', use_cache=False)"

      - name: Build Runtime Container
        run: |
          cd runtime_container/ && \
          docker build \
            --build-arg LLM_FORBIDDEN_WORDS="${{secrets.LLM_FORBIDDEN_WORDS}}" \
            --build-arg REDIS_HOST="${{secrets.REDIS_HOST}}" \
            -t opt-350m-openvino-int8 \
            .

      - name: Push to ECR
        run: |
          # TODO: Use commit hashes instead of 'latest'
          docker tag opt-350m-openvino-int8:latest ${{secrets.ECR_REPOSITORY}}/opt-350m-openvino-int8:latest
          docker push ${{secrets.ECR_REPOSITORY}}/opt-350m-openvino-int8:latest
